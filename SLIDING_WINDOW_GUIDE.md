# æ»‘åŠ¨çª—å£è®­ç»ƒä¸æµ‹è¯•æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æŒ‡å—ä»‹ç»å¦‚ä½•ä½¿ç”¨æ»‘åŠ¨çª—å£æ–¹æ³•è®­ç»ƒå’Œæµ‹è¯•TimeMixeræ¨¡å‹ã€‚ä¸ä¹‹å‰çš„å¤šæ¯”ä¾‹åˆ†å‰²æ–¹æ³•ä¸åŒï¼Œæ»‘åŠ¨çª—å£æ–¹æ³•å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

### âœ¨ æ ¸å¿ƒæ”¹è¿›

1. **å›ºå®šé•¿åº¦è¾“å…¥è¾“å‡º**ï¼š
   - `input_len`: è¾“å…¥åºåˆ—é•¿åº¦ï¼ˆå›ºå®šï¼‰
   - `output_len`: è¾“å‡ºåºåˆ—é•¿åº¦ï¼ˆå›ºå®šï¼‰
   - æ‰€æœ‰æ ·æœ¬çš„è¾“å…¥è¾“å‡ºé•¿åº¦å®Œå…¨ä¸€è‡´ï¼Œæ— å¡«å……ï¼Œæ— æˆªæ–­

2. **æ»‘åŠ¨çª—å£é‡‡æ ·**ï¼š
   - ä½¿ç”¨å›ºå®šæ­¥é•¿ `step_len` åœ¨æ¯å£äº•ä¸Šæ»‘åŠ¨é‡‡æ ·
   - é»˜è®¤æ­¥é•¿ = output_lenï¼ˆæ— é‡å ï¼‰
   - å¯è®¾ç½®è¾ƒå°æ­¥é•¿å¢åŠ æ ·æœ¬æ•°é‡ï¼ˆæœ‰é‡å ï¼‰

3. **ç»Ÿä¸€çš„è®­ç»ƒæµ‹è¯•ç­–ç•¥**ï¼š
   - è®­ç»ƒé›†ã€éªŒè¯é›†ã€æµ‹è¯•é›†ä½¿ç”¨ç›¸åŒçš„é‡‡æ ·æ–¹æ³•
   - äº•åˆ’åˆ†: 70% è®­ç»ƒï¼Œ10% éªŒè¯ï¼Œ20% æµ‹è¯•
   - æ¯å£äº•å†…éƒ¨ä½¿ç”¨æ»‘åŠ¨çª—å£ç”Ÿæˆå¤šä¸ªæ ·æœ¬

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. è®­ç»ƒæ¨¡å‹

```bash
python scripts/train_sliding_window.py \
  --model_id wellmix_sliding_640_160 \
  --input_len 640 \
  --output_len 160 \
  --step_len 160 \
  --train_epochs 100 \
  --batch_size 8 \
  --learning_rate 1e-4 \
  --use_gpu
```

**å‚æ•°è¯´æ˜**ï¼š
- `--model_id`: å®éªŒå”¯ä¸€æ ‡è¯†
- `--input_len`: è¾“å…¥åºåˆ—é•¿åº¦ï¼ˆä¾‹å¦‚ï¼š640æ­¥ï¼‰
- `--output_len`: è¾“å‡ºåºåˆ—é•¿åº¦ï¼ˆä¾‹å¦‚ï¼š160æ­¥ï¼Œæ¯”ä¾‹ 4:1ï¼‰
- `--step_len`: æ»‘åŠ¨æ­¥é•¿ï¼ˆé»˜è®¤=output_lenï¼Œæ— é‡å ï¼›å¯è®¾ä¸ºæ›´å°å€¼å¢åŠ æ ·æœ¬ï¼‰
- `--train_epochs`: è®­ç»ƒè½®æ•°
- `--batch_size`: æ‰¹å¤§å°
- `--learning_rate`: å­¦ä¹ ç‡
- `--use_gpu`: å¯ç”¨GPUåŠ é€Ÿï¼ˆMPS/CUDAï¼‰

### 2. æµ‹è¯•ä¸å¯è§†åŒ–

```bash
python scripts/test_sliding_window.py \
  --model_id wellmix_sliding_640_160 \
  --max_wells 5
```

**å‚æ•°è¯´æ˜**ï¼š
- `--model_id`: è¦æµ‹è¯•çš„æ¨¡å‹IDï¼ˆä¸è®­ç»ƒæ—¶ä¸€è‡´ï¼‰
- `--max_wells`: æœ€å¤šæµ‹è¯•å¤šå°‘å£äº•ï¼ˆé»˜è®¤ï¼šå…¨éƒ¨ï¼‰
- `--output_dir`: è¾“å‡ºç›®å½•ï¼ˆé»˜è®¤ï¼štest_results/<model_id>ï¼‰

## ğŸ“Š æ•°æ®é‡‡æ ·æœºåˆ¶

### æ»‘åŠ¨çª—å£ç¤ºä¾‹

å‡è®¾ä¸€å£äº•é•¿åº¦ä¸º 4000 æ­¥ï¼Œä½¿ç”¨ `input_len=640`, `output_len=160`, `step_len=160`ï¼š

```
äº•åºåˆ—: [0, 1, 2, ..., 3999]  (æ€»é•¿åº¦ 4000)

çª—å£1: input=[0:640]     output=[640:800]    (èµ·å§‹ä½ç½®: 0)
çª—å£2: input=[160:800]   output=[800:960]    (èµ·å§‹ä½ç½®: 160)
çª—å£3: input=[320:960]   output=[960:1120]   (èµ·å§‹ä½ç½®: 320)
...
çª—å£N: input=[3680:4320] (è¶…å‡º) - ä¸¢å¼ƒ

æ€»å…±ç”Ÿæˆçº¦ 24 ä¸ªæœ‰æ•ˆçª—å£
```

### ä¸åŒæ­¥é•¿çš„å½±å“

| step_len | çª—å£é‡å  | æ ·æœ¬æ•°é‡ | è®­ç»ƒæ—¶é—´ | é€‚ç”¨åœºæ™¯ |
|----------|---------|---------|---------|---------|
| output_len (160) | æ— é‡å  | åŸºå‡† | è¾ƒå¿« | æ ‡å‡†è®­ç»ƒ |
| output_len/2 (80) | 50%é‡å  | 2å€ | è¾ƒæ…¢ | æ•°æ®å¢å¼º |
| output_len*2 (320) | æœ‰é—´éš™ | 0.5å€ | å¾ˆå¿« | å¿«é€Ÿå®éªŒ |

## ğŸ”§ å‚æ•°è°ƒä¼˜å»ºè®®

### 1. è¾“å…¥è¾“å‡ºæ¯”ä¾‹é€‰æ‹©

| æ¯”ä¾‹ | input_len | output_len | é€‚ç”¨åœºæ™¯ |
|------|-----------|-----------|---------|
| 2:1  | 640       | 320       | çŸ­æœŸé¢„æµ‹ |
| 4:1  | 640       | 160       | **æ¨è** |
| 8:1  | 640       | 80        | é•¿æœŸé¢„æµ‹ |

### 2. äº•é•¿åº¦è¦æ±‚

ç¡®ä¿å¤§éƒ¨åˆ†äº•çš„é•¿åº¦ â‰¥ `input_len + output_len`ï¼Œå¦åˆ™æ— æ³•ç”Ÿæˆæœ‰æ•ˆçª—å£ã€‚

æŸ¥çœ‹æ•°æ®é›†ç»Ÿè®¡ï¼š
```python
import pandas as pd
df = pd.read_csv('data/preprocessed_daily_gas_by_well.csv')
lengths = df.count()
print(f"æœ€å°é•¿åº¦: {lengths.min()}")
print(f"å¹³å‡é•¿åº¦: {lengths.mean():.0f}")
print(f"æœ€å¤§é•¿åº¦: {lengths.max()}")
```

### 3. æ¨¡å‹å®¹é‡è®¾ç½®

| æ•°æ®è§„æ¨¡ | d_model | n_heads | e_layers | d_ff |
|---------|---------|---------|---------|------|
| å° (<50äº•) | 64 | 4 | 2 | 256 |
| ä¸­ (50-200äº•) | 128 | 8 | 3 | 512 |
| å¤§ (>200äº•) | 256 | 16 | 6 | 1024 |

## ğŸ“ æ–‡ä»¶ç»“æ„

è®­ç»ƒåä¼šç”Ÿæˆä»¥ä¸‹æ–‡ä»¶ï¼š

```
gas-timemix/
â”œâ”€â”€ checkpoints/
â”‚   â””â”€â”€ wellmix_sliding_640_160/
â”‚       â”œâ”€â”€ checkpoint.pth          # æ¨¡å‹æƒé‡
â”‚       â””â”€â”€ training_log.txt        # è®­ç»ƒæ—¥å¿—
â”œâ”€â”€ experiments/
â”‚   â””â”€â”€ wellmix_sliding_640_160/
â”‚       â””â”€â”€ config.json             # å®éªŒé…ç½®
â””â”€â”€ test_results/
    â””â”€â”€ wellmix_sliding_640_160/
        â”œâ”€â”€ results.csv             # è¯¦ç»†ç»“æœ
        â”œâ”€â”€ well_statistics.csv     # æŒ‰äº•ç»Ÿè®¡
        â””â”€â”€ well_*.pdf              # å¯è§†åŒ–å›¾ç‰‡
```

## ğŸ¨ å¯è§†åŒ–è¯´æ˜

æµ‹è¯•è„šæœ¬ç”Ÿæˆçš„å›¾è¡¨åŒ…å«ï¼š

- **æµ…ç°è‰²çº¿**: å®Œæ•´äº•åºåˆ—
- **è“è‰²æ®µ**: è¾“å…¥åºåˆ—ï¼ˆæ¯ä¸ªçª—å£ï¼‰
- **ç»¿è‰²å®çº¿**: çœŸå®è¾“å‡º
- **æ©™è‰²è™šçº¿**: é¢„æµ‹è¾“å‡º
- **çº¢è‰²è™šçº¿**: é¢„æµ‹èµ·ç‚¹æ ‡è®°

æ¯å£äº•ä¼šç”Ÿæˆä¸€å¼ åŒ…å«æ‰€æœ‰æ»‘åŠ¨çª—å£çš„é¢„æµ‹å¯è§†åŒ–å›¾ã€‚

## ğŸ†š ä¸æ—§æ–¹æ³•çš„å¯¹æ¯”

| ç‰¹æ€§ | æ—§æ–¹æ³• (å¤šæ¯”ä¾‹åˆ†å‰²) | æ–°æ–¹æ³• (æ»‘åŠ¨çª—å£) |
|------|-------------------|------------------|
| è¾“å…¥é•¿åº¦ | åŠ¨æ€ï¼ˆå¡«å……/æˆªæ–­ï¼‰ | å›ºå®šï¼ˆæ— å¡«å……ï¼‰ |
| é‡‡æ ·æ–¹å¼ | 10%-90%åˆ†å‰²ç‚¹ | æ»‘åŠ¨çª—å£ |
| æ ·æœ¬æ•°é‡ | æ¯äº•9ä¸ª | æ¯äº•Nä¸ªï¼ˆå–å†³äºstep_lenï¼‰ |
| è®­ç»ƒæµ‹è¯•ä¸€è‡´æ€§ | ä¸å®Œå…¨ä¸€è‡´ | **å®Œå…¨ä¸€è‡´** |
| å‚æ•°å«ä¹‰ | æ··æ·† | **æ¸…æ™°æ˜ç¡®** |

## ğŸ’¡ æœ€ä½³å®è·µ

1. **é¦–æ¬¡å®éªŒ**: ä½¿ç”¨é»˜è®¤å‚æ•°å¿«é€ŸéªŒè¯
   ```bash
   python scripts/train_sliding_window.py \
     --model_id test_640_160 \
     --input_len 640 \
     --output_len 160 \
     --train_epochs 10 \
     --use_gpu
   ```

2. **æ­£å¼è®­ç»ƒ**: å¢åŠ è®­ç»ƒè½®æ•°å’Œæ¨¡å‹å®¹é‡
   ```bash
   python scripts/train_sliding_window.py \
     --model_id prod_640_160 \
     --input_len 640 \
     --output_len 160 \
     --train_epochs 100 \
     --d_model 256 \
     --n_heads 16 \
     --e_layers 6 \
     --use_gpu
   ```

3. **æ•°æ®å¢å¼º**: ä½¿ç”¨é‡å çª—å£
   ```bash
   python scripts/train_sliding_window.py \
     --model_id augmented_640_160 \
     --input_len 640 \
     --output_len 160 \
     --step_len 80 \  # 50%é‡å 
     --train_epochs 50 \
     --use_gpu
   ```

## â“ å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•é€‰æ‹©åˆé€‚çš„input_lenå’Œoutput_lenï¼Ÿ

A: æ ¹æ®äº•çš„å¹³å‡é•¿åº¦å†³å®šã€‚å»ºè®® `input_len + output_len` â‰¤ å¹³å‡äº•é•¿åº¦çš„ 50%ï¼Œä»¥ç¡®ä¿æ¯å£äº•èƒ½ç”Ÿæˆè¶³å¤Ÿå¤šçš„çª—å£ã€‚

### Q2: step_lenåº”è¯¥è®¾ç½®å¤šå¤§ï¼Ÿ

A: 
- åˆå§‹å®éªŒ: `step_len = output_len`ï¼ˆæ— é‡å ï¼Œè®­ç»ƒæœ€å¿«ï¼‰
- æ•°æ®ä¸è¶³: `step_len = output_len / 2`ï¼ˆ50%é‡å ï¼Œå¢åŠ æ ·æœ¬ï¼‰
- æ•°æ®å……è¶³: `step_len = output_len * 2`ï¼ˆæœ‰é—´éš™ï¼Œå‡å°‘å†—ä½™ï¼‰

### Q3: è®­ç»ƒå¾ˆæ…¢æ€ä¹ˆåŠï¼Ÿ

A:
1. å‡å°batch_sizeï¼ˆå¦‚æœå†…å­˜ä¸è¶³ï¼‰
2. å¢å¤§step_lenï¼ˆå‡å°‘æ ·æœ¬æ•°ï¼‰
3. å‡å°æ¨¡å‹å®¹é‡ï¼ˆd_model, n_heads, e_layersï¼‰
4. å¯ç”¨GPUåŠ é€Ÿï¼ˆ--use_gpuï¼‰

### Q4: å¦‚ä½•ç»§ç»­ä¹‹å‰çš„è®­ç»ƒï¼Ÿ

A: ç›®å‰ä¸æ”¯æŒæ–­ç‚¹ç»­è®­ï¼Œå»ºè®®å¢åŠ patienceå‚æ•°ï¼ˆæ—©åœè€å¿ƒå€¼ï¼‰é¿å…è¿‡æ‹Ÿåˆã€‚

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. æ•°æ®è·¯å¾„æ˜¯å¦æ­£ç¡®ï¼ˆ--root_path, --data_pathï¼‰
2. äº•é•¿åº¦æ˜¯å¦æ»¡è¶³æœ€å°è¦æ±‚
3. GPUæ˜¯å¦å¯ç”¨ï¼ˆæ£€æŸ¥torch.backends.mps.is_available()ï¼‰
4. è®­ç»ƒæ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯

